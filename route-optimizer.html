<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>차량 경로 최적화 — 일렉션맵AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Pretendard Variable','Pretendard','system-ui','sans-serif']}}}}</script>
<link rel="stylesheet" href="css/custom.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  #map-container { position: relative; flex: 1; min-height: 0; }
  #map { width: 100%; height: 100%; }
  .left-panel { width: 340px; min-width: 340px; }
  .left-panel::-webkit-scrollbar { width: 5px; }
  .left-panel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .right-panel { width: 380px; min-width: 380px;
    transition: width 0.3s ease, min-width 0.3s ease, opacity 0.3s ease; overflow: hidden; }
  .right-panel.collapsed { width: 0; min-width: 0; opacity: 0; pointer-events: none; }
  .right-panel::-webkit-scrollbar { width: 5px; }
  .right-panel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .panel-toggle-bar { width: 20px; min-width: 20px; background: #16a34a; border-left: 1px solid #15803d;
    border-right: 1px solid #15803d; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.15s ease; }
  .panel-toggle-bar:hover { background: #15803d; }
  .panel-toggle-bar svg { transition: transform 0.3s ease; stroke-width: 3; }
  .spot-item { transition: all 0.15s ease; }
  .spot-item:hover { background: #eff6ff; }
  .spot-item.checked { background: #eff6ff; border-color: #93c5fd; }
  .bottom-toggle-bar { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1001;
    height: 22px; background: #1e293b; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.15s ease, bottom 0.4s cubic-bezier(0.16,1,0.3,1); }
  .bottom-toggle-bar:hover { background: #334155; }
  .bottom-toggle-bar svg { transition: transform 0.3s ease; }
  .bottom-toggle-bar.panel-open { bottom: 0; }
  .bottom-panel { position: absolute; bottom: 22px; left: 0; right: 0; z-index: 1000;
    background: white; border-top: 2px solid #e2e8f0; border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.12); max-height: 48%; overflow: hidden;
    transform: translateY(calc(100% + 22px)); transition: transform 0.4s cubic-bezier(0.16,1,0.3,1); }
  .bottom-panel.show { transform: translateY(0); }
  .bottom-toggle-bar.panel-open { transition: bottom 0.4s cubic-bezier(0.16,1,0.3,1); }
  .bottom-panel-inner { overflow-y: auto; max-height: calc(50vh - 56px); }
  .tab-btn { transition: all 0.15s ease; }
  .tab-btn.active { color: #2563eb; border-color: #2563eb; background: #eff6ff; }
  .vehicle-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px;
    border-radius: 9999px; font-size: 12px; font-weight: 600; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { width: 24px; height: 24px; border: 3px solid #bfdbfe; border-top-color: #2563eb;
    border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
  .start-marker-icon {
    background: #f59e0b; color: white; border-radius: 50%; width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
    border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.35);
  }
  .type-badge {
    display: inline-block; padding: 1px 8px; border-radius: 9999px;
    font-size: 11px; font-weight: 500; line-height: 1.6;
  }
  .type-교통 { background: #dbeafe; color: #1d4ed8; }
  .type-시장 { background: #fef3c7; color: #92400e; }
  .type-주거 { background: #d1fae5; color: #065f46; }
  .type-상업 { background: #fce7f3; color: #9d174d; }
  .type-관공서 { background: #e0e7ff; color: #3730a3; }
  .type-관광 { background: #fef9c3; color: #854d0e; }
  .type-대학교 { background: #ede9fe; color: #5b21b6; }
  .type-공원 { background: #dcfce7; color: #166534; }
  .route-modal-overlay { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center;
    justify-content: center; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
  .route-modal { background: white; border-radius: 16px; box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    width: 92vw; max-width: 1100px; max-height: 88vh; display: flex; flex-direction: column; }
  .route-svg-label { font-family: 'Pretendard Variable', sans-serif; }
  .subtype-btn { padding: 3px 10px; border-radius: 6px; font-size: 13px; font-weight: 600;
    border: 1.5px solid #e2e8f0; background: white; color: #64748b; cursor: pointer; transition: all 0.15s ease; }
  .subtype-btn:hover { border-color: #93c5fd; color: #2563eb; background: #eff6ff; }
  .subtype-btn.active { border-color: #2563eb; background: #2563eb; color: white; }
</style>
</head>
<body class="antialiased bg-white text-gray-900">
<div id="test-banner"></div>
<div id="app-header"></div>

<!-- Main Layout -->
<div class="flex" style="height: calc(100vh - 105px);">

  <!-- Left Panel -->
  <div class="left-panel bg-white border-r border-gray-200 flex flex-col overflow-y-auto">

    <!-- Title -->
    <div class="px-4 py-2 border-b border-gray-100 bg-gray-50/80">
      <h1 class="text-xl font-bold text-gray-900 flex items-center gap-1.5">
        <span class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center text-base">&#x1F697;</span>
        차량 경로 최적화
      </h1>
    </div>

    <!-- 선거 유형 -->
    <div class="px-4 py-2 border-b border-gray-100">
      <h2 class="text-sm font-bold text-gray-700 mb-1.5 flex items-center gap-1.5">
        <span class="w-5 h-5 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">1</span>
        선거 유형
      </h2>
      <select id="election-type-select" class="w-full text-sm border border-gray-200 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
      </select>

      <!-- 세부 유형 버튼 -->
      <div id="election-subtype-wrap" class="mt-1.5 hidden">
        <div id="election-subtype-btns" class="flex flex-wrap gap-1"></div>
      </div>

      <div id="election-type-info" class="mt-1.5 text-sm bg-gray-50 rounded px-2.5 py-1.5 hidden">
        <div class="flex items-center justify-between text-gray-600">
          <span id="election-scope-text" class="font-medium text-gray-700"></span>
          <span id="election-vehicle-text" class="text-gray-400"></span>
        </div>
        <div class="flex items-center justify-between mt-0.5 text-gray-500">
          <span id="election-budget-text"></span>
          <span id="election-period-text"></span>
        </div>
      </div>
    </div>

    <!-- 출마 지역 -->
    <div id="region-section" class="px-4 py-2 border-b border-gray-100">
      <h2 class="text-sm font-bold text-gray-700 mb-1 flex items-center gap-1.5">
        <span class="w-5 h-5 bg-purple-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">2</span>
        <span id="region-title">출마 지역</span>
      </h2>
      <p id="region-desc" class="text-sm text-gray-500 mb-1 leading-tight"></p>
      <select id="sido-select" class="w-full text-sm border border-gray-200 rounded-lg px-2.5 py-1.5 mb-1 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
      </select>
      <select id="sigungu-select" class="w-full text-sm border border-gray-200 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white hidden">
      </select>
    </div>

    <!-- 출발점 설정 -->
    <div class="px-4 py-2 border-b border-gray-100">
      <h2 class="text-sm font-bold text-gray-700 mb-1.5 flex items-center gap-1.5">
        <span class="w-5 h-5 bg-amber-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">3</span>
        출발점 설정
      </h2>
      <select id="start-point-select" class="w-full text-sm border border-gray-200 rounded-lg px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
        <option value="custom">직접 선택 (지도 클릭)</option>
      </select>
      <div id="start-point-info" class="mt-1 text-sm text-gray-500 bg-gray-50 rounded px-2.5 py-1.5 hidden">
        <span id="start-point-name" class="font-medium text-gray-700"></span>
        <span id="start-point-coords" class="block text-gray-400 mt-0.5"></span>
      </div>
    </div>

    <!-- 유세 거점 (요약) -->
    <div class="px-4 py-2 border-b border-gray-100">
      <div class="flex items-center justify-between mb-1.5">
        <h2 class="text-sm font-bold text-gray-700 flex items-center gap-1.5">
          <span class="w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">4</span>
          유세 거점
        </h2>
        <button onclick="toggleRightPanel()" class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center gap-0.5 transition">
          <span id="right-panel-toggle-text">상세 보기</span>
          <svg id="right-panel-toggle-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="changeSpotCount(-1)" class="w-7 h-7 rounded border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition text-sm font-bold">&minus;</button>
        <input type="number" id="spot-count-input" min="1" value="5" class="w-14 text-center text-base font-bold text-blue-600 border border-gray-200 rounded py-1 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="onSpotCountChange()">
        <button onclick="changeSpotCount(1)" class="w-7 h-7 rounded border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition text-sm font-bold">+</button>
        <span id="spot-max-label" class="text-sm text-gray-400">/ 전체 0개</span>
        <span class="text-sm text-gray-400 ml-auto" id="spot-count">0개 선택</span>
      </div>
      <span id="spot-total" class="hidden"></span>
    </div>

    <!-- 차량 설정 -->
    <div class="px-4 py-2 border-b border-gray-100">
      <h2 class="text-sm font-bold text-gray-700 mb-1.5 flex items-center gap-1.5">
        <span class="w-5 h-5 bg-emerald-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">5</span>
        차량 설정
      </h2>
      <div class="flex items-center gap-2 mb-2">
        <span class="text-sm text-gray-600 w-14">차량 수</span>
        <button onclick="changeVehicleCount(-1)" class="w-7 h-7 rounded border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition text-sm font-bold">&minus;</button>
        <input type="number" id="vehicle-count" min="1" value="2" class="w-14 text-center text-base font-bold text-blue-600 border border-gray-200 rounded py-1 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="onVehicleCountChange()">
        <button onclick="changeVehicleCount(1)" class="w-7 h-7 rounded border border-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-50 transition text-sm font-bold">+</button>
        <span class="text-sm text-gray-400">대</span>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-sm text-gray-500 block mb-0.5">시작</label>
          <select id="start-time" class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="07:00">07:00</option>
            <option value="07:30">07:30</option>
            <option value="08:00" selected>08:00</option>
            <option value="08:30">08:30</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-500 block mb-0.5">종료</label>
          <select id="end-time" class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="15:00">15:00</option>
            <option value="16:00">16:00</option>
            <option value="17:00">17:00</option>
            <option value="18:00" selected>18:00</option>
            <option value="19:00">19:00</option>
            <option value="20:00">20:00</option>
            <option value="21:00">21:00</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 실행 버튼 -->
    <div class="px-4 py-3">
      <button id="optimize-btn" onclick="runOptimization()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-xl transition shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2 text-base">
        &#x1F697; 경로 최적화 실행
      </button>
      <div class="flex justify-center my-1 text-gray-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
      </div>
      <button id="route-detail-btn" onclick="showRouteDetail()" class="w-full mt-2 border-2 border-emerald-500 text-emerald-700 hover:bg-emerald-50 font-bold py-2 rounded-xl transition flex items-center justify-center gap-2 text-base disabled:opacity-40 disabled:cursor-not-allowed" disabled>
        &#x1F4CB; 차량별 경로 상세보기
      </button>
      <div id="loading-state" class="hidden mt-2 text-center">
        <div class="spinner mx-auto mb-1"></div>
        <p class="text-sm text-gray-500" id="loading-text">최적 경로 계산 중...</p>
      </div>
    </div>

  </div>

  <!-- Toggle Bar (패널 사이 토글) -->
  <div id="panel-toggle-bar" class="panel-toggle-bar" onclick="toggleRightPanel()" title="거점 상세 패널 열기/닫기">
    <svg id="toggle-bar-icon" class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
  </div>

  <!-- Right Panel (거점 상세) — 왼쪽 패널 바로 옆 -->
  <div id="right-panel" class="right-panel collapsed bg-white border-r border-gray-200 flex flex-col overflow-y-auto">

    <!-- 패널 헤더 -->
    <div class="px-4 py-1.5 border-b border-gray-100 bg-gray-50/80">
      <h2 class="text-xl font-bold text-gray-900 flex items-center gap-1.5">
        <span class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center text-base">&#x1F4CD;</span>
        유세 거점 상세목록
      </h2>
    </div>

    <!-- 구역 필터 -->
    <div class="px-5 py-3 border-b border-gray-100">
      <label class="text-xs text-gray-600 block mb-1.5">구역 필터</label>
      <select id="district-filter" class="w-full text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
        <option value="all">전체 구역</option>
      </select>
    </div>

    <!-- 거점 목록 -->
    <div class="flex-1 overflow-y-auto px-5 py-3">
      <div id="spot-list" class="space-y-1"></div>
    </div>

  </div>

  <!-- Map Area -->
  <div id="map-container">
    <div id="map"></div>

    <!-- Bottom Toggle Bar -->
    <div id="bottom-toggle-bar" class="bottom-toggle-bar hidden" onclick="toggleBottomPanel()">
      <svg id="bottom-toggle-icon" class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"/></svg>
    </div>

    <!-- Bottom Panel (results) -->
    <div id="bottom-panel" class="bottom-panel">
      <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100 bg-gray-50/80">
        <div class="flex items-center gap-3 overflow-x-auto" id="result-tabs"></div>
        <button onclick="toggleBottomPanel()" class="text-gray-400 hover:text-gray-600 p-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
      </div>
      <div class="bottom-panel-inner" id="result-content"></div>
    </div>
  </div>
</div>

<!-- Route Detail Modal -->
<div id="route-detail-modal" class="route-modal-overlay hidden">
  <div class="route-modal">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-2xl">
      <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        &#x1F4CB; 차량별 경로 상세보기
      </h2>
      <button onclick="closeRouteDetail()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-200 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="route-detail-content" class="flex-1 overflow-y-auto p-6"></div>
  </div>
</div>

<script src="js/mock-data.js"></script>
<script src="js/shared.js"></script>
<script src="js/map-engine.js"></script>
<script src="js/route-algorithm.js"></script>
<script>
/* ═══════════════════════════════════════════
   경로 최적화 페이지 로직
   ═══════════════════════════════════════════ */

// 전역 상태
var map;
var vehicleCount = 2;
var selectedSpots = new Set();
var startPoint = null;
var optimizationResult = null;
var mapLayers = [];       // 현재 지도에 추가된 레이어들
var spotMarkers = [];     // 거점 마커들
var startMarker = null;   // 출발점 마커

var currentSidoSpots = [];  // 현재 시·도에 해당하는 거점 목록
var currentElectionType = null; // 현재 선택된 선거 유형

// 선거 유형별 범위 분류
var ELECTION_SCOPE = {
  president: 'national',
  proportional: 'national',
  metro_governor: 'sido',
  superintendent: 'sido',
  national_assembly: 'district',
  basic_head: 'district',
  metro_council: 'district',
  basic_council: 'district'
};

// 선거 유형별 세부 분류
var ELECTION_SUBTYPES = {
  metro_governor: [
    { id: 'metro_mayor', name: '시장', desc: '특별시·광역시·특별자치시장', sidoFilter: function(s) { return s.endsWith('시'); } },
    { id: 'governor', name: '도지사', desc: '도·특별자치도지사', sidoFilter: function(s) { return s.endsWith('도'); } }
  ],
  basic_head: [
    { id: 'city_mayor', name: '시장', desc: '시장 선거' },
    { id: 'county_head', name: '군수', desc: '군수 선거' },
    { id: 'district_head', name: '구청장', desc: '구청장 선거' }
  ],
  national_assembly: [
    { id: 'district_rep', name: '지역구', desc: '지역구 국회의원', scope: 'district' },
    { id: 'proportional_rep', name: '비례대표', desc: '비례대표 국회의원', scope: 'national' }
  ],
  metro_council: [
    { id: 'district_metro', name: '지역구', desc: '지역구 광역의원', scope: 'district' },
    { id: 'proportional_metro', name: '비례대표', desc: '비례대표 광역의원', scope: 'national' }
  ],
  basic_council: [
    { id: 'district_basic', name: '지역구', desc: '지역구 기초의원', scope: 'district' },
    { id: 'proportional_basic', name: '비례대표', desc: '비례대표 기초의원', scope: 'national' }
  ]
};

var currentSubtype = null;  // 현재 선택된 세부 유형

var VEHICLE_COLORS = ['blue', 'red', 'green', 'orange', 'purple', 'pink', 'cyan', 'lime', 'amber', 'indigo'];
var VEHICLE_HEX = { blue: '#2563eb', red: '#dc2626', green: '#059669', orange: '#ea580c', purple: '#7c3aed', pink: '#db2777', cyan: '#0891b2', lime: '#65a30d', amber: '#d97706', indigo: '#4f46e5' };

// 차량 이름 동적 생성
function getVehicleName(idx) {
  return '차량 ' + (idx + 1);
}
// 기존 호환용
var VEHICLE_NAMES = [];
for (var _vi = 0; _vi < 100; _vi++) VEHICLE_NAMES.push('차량 ' + (_vi + 1));

/* ── 초기화 ── */
initPage('route');

// 지도 초기화
map = initMap('map', [36.5, 127.8], 7);

// 지도 클릭 시 출발점 설정
map.on('click', function(e) {
  var sel = document.getElementById('start-point-select');
  if (sel.value === 'custom') {
    setStartPoint({ lat: e.latlng.lat, lng: e.latlng.lng, name: '사용자 지정 출발점' });
  }
});

/* ── 선거 유형 드롭다운 ── */
(function populateElectionType() {
  var sel = document.getElementById('election-type-select');
  ELECTION_TYPES.forEach(function(et) {
    var opt = document.createElement('option');
    opt.value = et.id;
    opt.textContent = et.icon + ' ' + et.name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', function() {
    onElectionTypeChange(this.value);
  });
})();

function onElectionTypeChange(typeId) {
  currentElectionType = ELECTION_TYPES.find(function(e) { return e.id === typeId; });
  currentSubtype = null;
  var scope = ELECTION_SCOPE[typeId] || 'national';
  var infoEl = document.getElementById('election-type-info');
  var sigunguSel = document.getElementById('sigungu-select');

  // 선거 정보 표시
  if (currentElectionType) {
    infoEl.classList.remove('hidden');
    document.getElementById('election-scope-text').textContent = currentElectionType.desc;
    document.getElementById('election-vehicle-text').textContent = '추천 차량: ' + currentElectionType.recommendVehicles;
    document.getElementById('election-budget-text').textContent = '선거비용: ' + currentElectionType.budgetText;
    document.getElementById('election-period-text').textContent = '선거기간: ' + currentElectionType.period;
  }

  // 세부 유형 버튼 렌더링
  renderSubtypeButtons(typeId);

  // 출마 지역 섹션 업데이트
  updateRegionSection(scope);

  // 시·도 필터 갱신 (세부 유형에 따른 필터 없이 전체)
  filterSidoOptions(null);

  // 시·도 변경 트리거 (거점 갱신)
  var sidoSel = document.getElementById('sido-select');
  if (sidoSel.value) {
    onSidoChange(sidoSel.value);
  }
}

// 세부 유형 버튼 렌더링
function renderSubtypeButtons(typeId) {
  var wrap = document.getElementById('election-subtype-wrap');
  var btnsEl = document.getElementById('election-subtype-btns');
  var subtypes = ELECTION_SUBTYPES[typeId];

  if (!subtypes || subtypes.length === 0) {
    wrap.classList.add('hidden');
    btnsEl.innerHTML = '';
    return;
  }

  wrap.classList.remove('hidden');
  var html = '';
  subtypes.forEach(function(st) {
    html += '<button class="subtype-btn" data-subtype-id="' + st.id + '" ' +
      'onclick="selectSubtype(\'' + typeId + '\', \'' + st.id + '\', this)" ' +
      'title="' + st.desc + '">' + st.name + '</button>';
  });
  btnsEl.innerHTML = html;
}

// 세부 유형 선택
function selectSubtype(typeId, subtypeId, btnEl) {
  var subtypes = ELECTION_SUBTYPES[typeId];
  if (!subtypes) return;
  currentSubtype = subtypes.find(function(st) { return st.id === subtypeId; });

  // 버튼 활성화
  var allBtns = document.querySelectorAll('#election-subtype-btns .subtype-btn');
  allBtns.forEach(function(b) { b.classList.remove('active'); });
  btnEl.classList.add('active');

  // 세부 유형에 scope 오버라이드가 있으면 적용
  var scope = ELECTION_SCOPE[typeId] || 'national';
  if (currentSubtype && currentSubtype.scope) {
    scope = currentSubtype.scope;
  }

  // 출마 지역 섹션 업데이트
  updateRegionSection(scope);

  // 시·도 필터 적용 (광역단체장 시장/도지사 등)
  if (currentSubtype && currentSubtype.sidoFilter) {
    filterSidoOptions(currentSubtype.sidoFilter);
  } else {
    filterSidoOptions(null);
  }

  // 시·도 변경 트리거
  var sidoSel = document.getElementById('sido-select');
  if (sidoSel.value) {
    onSidoChange(sidoSel.value);
  }
}

// 출마 지역 섹션 UI 업데이트
function updateRegionSection(scope) {
  var sigunguSel = document.getElementById('sigungu-select');

  if (scope === 'national') {
    document.getElementById('region-title').textContent = '경로 계획 지역';
    document.getElementById('region-desc').textContent = '전국 단위 선거입니다. 경로를 계획할 시·도를 선택하세요.';
    sigunguSel.classList.add('hidden');
  } else if (scope === 'sido') {
    document.getElementById('region-title').textContent = '출마 지역';
    document.getElementById('region-desc').textContent = '출마할 시·도를 선택하세요.';
    sigunguSel.classList.add('hidden');
  } else {
    document.getElementById('region-title').textContent = '출마 지역';
    document.getElementById('region-desc').textContent = '출마할 시·도와 선거구를 선택하세요.';
    sigunguSel.classList.remove('hidden');
    updateSigunguSelect(document.getElementById('sido-select').value);
  }
}

// 시·도 옵션 필터링 (세부 유형에 따라)
function filterSidoOptions(filterFn) {
  var sel = document.getElementById('sido-select');
  var sidoList = getSidoList();
  var prevValue = sel.value;
  sel.innerHTML = '';

  sidoList.forEach(function(sido) {
    if (filterFn && !filterFn(sido)) return;
    var opt = document.createElement('option');
    opt.value = sido;
    opt.textContent = sido;
    sel.appendChild(opt);
  });

  // 이전 선택값이 여전히 있으면 유지, 아니면 첫 번째 옵션
  var found = false;
  for (var i = 0; i < sel.options.length; i++) {
    if (sel.options[i].value === prevValue) { sel.value = prevValue; found = true; break; }
  }
  if (!found && sel.options.length > 0) {
    sel.value = sel.options[0].value;
  }
}

// 시·군·구 드롭다운 갱신
function updateSigunguSelect(sido) {
  var sel = document.getElementById('sigungu-select');
  sel.innerHTML = '<option value="all">전체 선거구</option>';
  var districts = getDistrictsBySido(sido);
  districts.forEach(function(d) {
    var opt = document.createElement('option');
    opt.value = d.dong;
    opt.textContent = d.dong + ' (유권자 ' + (d.voters ? d.voters.toLocaleString() : '-') + '명)';
    sel.appendChild(opt);
  });
}

// 시·군·구 변경 이벤트
document.getElementById('sigungu-select').addEventListener('change', function() {
  var dong = this.value;
  var distFilter = document.getElementById('district-filter');
  if (dong === 'all') {
    distFilter.value = 'all';
  } else {
    // 해당 구역이 district-filter에 있으면 자동 선택
    for (var i = 0; i < distFilter.options.length; i++) {
      if (distFilter.options[i].value === dong) {
        distFilter.value = dong;
        break;
      }
    }
  }
  applySpotCount();
});

// 시·도 드롭다운 초기화
(function initSidoSelect() {
  filterSidoOptions(null);
  document.getElementById('sido-select').addEventListener('change', function() {
    onSidoChange(this.value);
  });
})();

// 출발점 드롭다운 이벤트
document.getElementById('start-point-select').addEventListener('change', function() {
  if (this.value === 'custom') {
    startPoint = null;
    hideStartInfo();
    clearStartMarker();
  } else {
    var spot = currentSidoSpots.find(function(s) { return s.id === parseInt(this.value); }.bind(this));
    if (spot) setStartPoint(spot);
  }
});

// 구역 필터 이벤트
document.getElementById('district-filter').addEventListener('change', function() { applySpotCount(); });

// 시·도 변경 시: 구역 필터, 출발점, 거점 목록 모두 갱신
function onSidoChange(sido) {
  // 현재 시·도 거점 갱신
  currentSidoSpots = getSpotsBySido(sido);

  // 선택 초기화
  selectedSpots.clear();

  // 시·군·구 드롭다운 갱신 (district-level 선거 시)
  var scope = currentElectionType ? (ELECTION_SCOPE[currentElectionType.id] || 'national') : 'national';
  if (scope === 'district') {
    updateSigunguSelect(sido);
    document.getElementById('sigungu-select').value = 'all';
  }

  // 구역 필터 갱신
  var distSel = document.getElementById('district-filter');
  distSel.innerHTML = '<option value="all">전체 구역</option>';
  var districts = [];
  currentSidoSpots.forEach(function(s) {
    if (districts.indexOf(s.district) === -1) districts.push(s.district);
  });
  districts.sort();
  districts.forEach(function(d) {
    var opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d;
    distSel.appendChild(opt);
  });

  // 출발점 드롭다운 갱신
  var startSel = document.getElementById('start-point-select');
  startSel.innerHTML = '<option value="custom">직접 선택 (지도 클릭)</option>';
  currentSidoSpots.forEach(function(spot) {
    var opt = document.createElement('option');
    opt.value = spot.id;
    opt.textContent = spot.name + ' (' + spot.district + ')';
    startSel.appendChild(opt);
  });

  // 기본 출발점: 해당 시·도의 첫 번째 관공서 타입 거점
  var defaultStart = currentSidoSpots.find(function(s) { return s.type === '관공서'; });
  if (defaultStart) {
    startSel.value = defaultStart.id;
    setStartPoint(defaultStart);
  } else if (currentSidoSpots.length > 0) {
    startSel.value = currentSidoSpots[0].id;
    setStartPoint(currentSidoSpots[0]);
  } else {
    startPoint = null;
    hideStartInfo();
    clearStartMarker();
  }

  // 거점 개수 입력란의 max와 기본값을 해당 시·도 거점 수에 맞게 설정
  var totalSpots = currentSidoSpots.length;
  var input = document.getElementById('spot-count-input');
  input.max = totalSpots;
  // 기본값: 전체 거점의 절반 (최소 2, 최대 전체)
  var defaultCount = Math.max(2, Math.min(Math.round(totalSpots / 2), totalSpots));
  input.value = defaultCount;
  document.getElementById('spot-max-label').textContent = '/ 전체 ' + totalSpots + '개';

  // 거점 목록 & 마커 갱신 (개수 기반 자동 선택 포함)
  applySpotCount();

  // 지도 뷰를 해당 시·도 거점이 보이도록 이동
  if (currentSidoSpots.length > 0) {
    var points = currentSidoSpots.map(function(s) { return [s.lat, s.lng]; });
    fitMapBounds(map, points);
  }
}

// 초기 로드: 선거 유형 → 시·도 순서로 설정
(function initPage_route() {
  // 선거 유형 기본값 (국회의원 선거)
  var etSel = document.getElementById('election-type-select');
  etSel.value = 'national_assembly';
  onElectionTypeChange('national_assembly');

  // 시·도 기본값
  var sidoSel = document.getElementById('sido-select');
  if (sidoSel.options.length > 0) {
    onSidoChange(sidoSel.options[0].value);
  }
})();

/* ── 출발점 관련 ── */
function setStartPoint(spot) {
  startPoint = { lat: spot.lat, lng: spot.lng, name: spot.name || '출발점' };
  document.getElementById('start-point-info').classList.remove('hidden');
  document.getElementById('start-point-name').textContent = startPoint.name;
  document.getElementById('start-point-coords').textContent = startPoint.lat.toFixed(4) + ', ' + startPoint.lng.toFixed(4);
  clearStartMarker();
  var icon = L.divIcon({
    className: 'custom-div-icon',
    html: '<div class="start-marker-icon">&#x2605;</div>',
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    popupAnchor: [0, -22]
  });
  startMarker = L.marker([startPoint.lat, startPoint.lng], { icon: icon }).addTo(map);
  startMarker.bindPopup('<div class="text-center"><p class="font-bold text-sm">' + startPoint.name + '</p><p class="text-xs text-gray-500">출발점</p></div>');
}

function clearStartMarker() {
  if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
}

function hideStartInfo() {
  document.getElementById('start-point-info').classList.add('hidden');
}

/* ── 거점 목록 ── */
function renderSpotList() {
  var filter = document.getElementById('district-filter').value;
  var spots = currentSidoSpots.slice();
  if (filter !== 'all') {
    spots = spots.filter(function(s) { return s.district === filter; });
  }

  // 유권자 도달 수 기준 내림차순 정렬
  spots.sort(function(a, b) { return b.voterReach - a.voterReach; });

  // 입력된 개수만큼만 표시
  var count = parseInt(document.getElementById('spot-count-input').value) || spots.length;
  spots = spots.slice(0, count);

  document.getElementById('spot-total').textContent = '표시 ' + spots.length + '개';

  var html = '';
  spots.forEach(function(spot) {
    var checked = selectedSpots.has(spot.id);
    html += '<label class="spot-item flex items-center gap-2 px-2.5 py-1.5 rounded-lg border cursor-pointer ' +
      (checked ? 'checked border-blue-200 bg-blue-50/50' : 'border-gray-100 bg-white') + '">' +
      '<input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" ' +
      'value="' + spot.id + '" ' + (checked ? 'checked' : '') +
      ' onchange="toggleSpot(' + spot.id + ', this.checked)">' +
      '<span class="text-sm font-semibold text-gray-800 truncate">' + spot.name + '</span>' +
      '<span class="type-badge type-' + spot.type + '">' + spot.type + '</span>' +
      '<span class="ml-auto text-xs text-gray-400 whitespace-nowrap">' + fmt(spot.voterReach) + ' · ' + spot.peakHour + '</span>' +
      '</label>';
  });

  document.getElementById('spot-list').innerHTML = html;
}

function toggleSpot(spotId, checked) {
  if (checked) {
    selectedSpots.add(spotId);
  } else {
    selectedSpots.delete(spotId);
  }
  updateSpotCount();
  renderSpotList();
  renderSpotMarkers();
}

/* ── 거점 개수 조절 ── */
function changeSpotCount(delta) {
  var input = document.getElementById('spot-count-input');
  var max = parseInt(input.max) || currentSidoSpots.length;
  var newVal = Math.max(1, Math.min(max, parseInt(input.value || 0) + delta));
  input.value = newVal;
  applySpotCount();
}

function onSpotCountChange() {
  var input = document.getElementById('spot-count-input');
  var max = parseInt(input.max) || currentSidoSpots.length;
  var val = parseInt(input.value);
  if (isNaN(val) || val < 1) val = 1;
  if (val > max) val = max;
  input.value = val;
  applySpotCount();
}

// 입력된 개수만큼 상위 거점을 선택하고 목록을 갱신
function applySpotCount() {
  var input = document.getElementById('spot-count-input');
  var count = parseInt(input.value) || 1;
  var filter = document.getElementById('district-filter').value;

  // 구역 필터 적용된 거점 가져오기
  var spots = currentSidoSpots.slice();
  if (filter !== 'all') {
    spots = spots.filter(function(s) { return s.district === filter; });
  }

  // 유권자 도달 수 기준 내림차순 정렬
  spots.sort(function(a, b) { return b.voterReach - a.voterReach; });

  // 입력 개수만큼만 자르기
  var topSpots = spots.slice(0, count);

  // 선택 초기화 후 상위 거점만 자동 선택
  selectedSpots.clear();
  topSpots.forEach(function(s) { selectedSpots.add(s.id); });

  updateSpotCount();
  renderSpotList();
  renderSpotMarkers();
}

function updateSpotCount() {
  document.getElementById('spot-count').textContent = selectedSpots.size + '개 거점 선택됨';
}

/* ── 거점 마커 (기본 상태) ── */
function renderSpotMarkers() {
  // 기존 마커 제거
  spotMarkers.forEach(function(m) { map.removeLayer(m); });
  spotMarkers = [];

  currentSidoSpots.forEach(function(spot) {
    var isSelected = selectedSpots.has(spot.id);
    var icon = L.divIcon({
      className: 'custom-div-icon',
      html: '<div style="' +
        'background:' + (isSelected ? '#2563eb' : '#94a3b8') + ';' +
        'color:white;border-radius:50%;width:' + (isSelected ? '26' : '20') + 'px;height:' + (isSelected ? '26' : '20') + 'px;' +
        'display:flex;align-items:center;justify-content:center;font-weight:700;font-size:' + (isSelected ? '11' : '9') + 'px;' +
        'border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.25);' +
        'opacity:' + (isSelected ? '1' : '0.6') + ';' +
        'font-family:Pretendard Variable,sans-serif;' +
        '">' + spot.id + '</div>',
      iconSize: [isSelected ? 26 : 20, isSelected ? 26 : 20],
      iconAnchor: [isSelected ? 13 : 10, isSelected ? 13 : 10],
      popupAnchor: [0, isSelected ? -15 : -12]
    });

    var marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
    marker.bindPopup(
      '<div><p class="font-bold text-sm">' + spot.name + '</p>' +
      '<p class="text-xs text-gray-500 mt-1">' + spot.district + ' / ' + spot.type + '</p>' +
      '<p class="text-xs mt-1">유권자 도달: <b>' + fmt(spot.voterReach) + '</b></p>' +
      '<p class="text-xs">피크 시간: <b>' + spot.peakHour + '</b></p></div>'
    );
    spotMarkers.push(marker);
  });
}

/* ── 차량 수 변경 ── */
function changeVehicleCount(delta) {
  var input = document.getElementById('vehicle-count');
  vehicleCount = Math.max(1, parseInt(input.value || 1) + delta);
  input.value = vehicleCount;
}

function onVehicleCountChange() {
  var input = document.getElementById('vehicle-count');
  var val = parseInt(input.value);
  if (isNaN(val) || val < 1) val = 1;
  vehicleCount = val;
  input.value = vehicleCount;
}

/* ── 오른쪽 패널 토글 ── */
function toggleRightPanel() {
  var panel = document.getElementById('right-panel');
  var toggleText = document.getElementById('right-panel-toggle-text');
  var toggleIcon = document.getElementById('right-panel-toggle-icon');
  var barIcon = document.getElementById('toggle-bar-icon');

  panel.classList.toggle('collapsed');

  var isOpen = !panel.classList.contains('collapsed');
  toggleText.textContent = isOpen ? '상세 닫기' : '상세 보기';
  toggleIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
  // 토글 바 아이콘: 열림→왼쪽 화살표(닫기), 닫힘→오른쪽 화살표(열기)
  if (barIcon) barIcon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';

  // 지도 리사이즈
  setTimeout(function() { map.invalidateSize(); }, 350);
}

/* ── 경로 최적화 실행 ── */
async function runOptimization() {
  // 유효성 검증
  if (!startPoint) {
    alert('출발점을 설정해주세요.');
    return;
  }
  if (selectedSpots.size < 2) {
    alert('최소 2개 이상의 유세 거점을 선택해주세요.');
    return;
  }

  // UI 상태: 로딩
  var btn = document.getElementById('optimize-btn');
  var loading = document.getElementById('loading-state');
  btn.disabled = true;
  btn.classList.add('opacity-50', 'cursor-not-allowed');
  loading.classList.remove('hidden');
  document.getElementById('loading-text').textContent = '최적 경로 계산 중...';

  // 잠깐 기다려서 UI 업데이트 반영
  await sleep(100);

  try {
    // 선택된 거점 모으기
    var spots = currentSidoSpots.filter(function(s) { return selectedSpots.has(s.id); });
    vehicleCount = parseInt(document.getElementById('vehicle-count').value) || 1;
    var numVehicles = Math.min(vehicleCount, spots.length);
    var startTime = document.getElementById('start-time').value;

    // 1. 차량 경로 계획
    document.getElementById('loading-text').textContent = 'VRP 알고리즘 실행 중... (' + spots.length + '개 거점, ' + numVehicles + '대 차량)';
    await sleep(300);

    var results = vehicleRoutePlan(spots, numVehicles, startPoint);

    // 2. 각 차량별 일정 추정
    document.getElementById('loading-text').textContent = '일정 계산 중...';
    await sleep(200);

    for (var v = 0; v < results.length; v++) {
      var r = results[v];
      r.schedule = estimateSchedule(r.routeLocalOrder, r.spots, startTime, r.distMatrix);
    }

    // 3. 커버리지 계산
    var allRouteSpots = [];
    for (var v = 0; v < results.length; v++) {
      allRouteSpots = allRouteSpots.concat(results[v].clusterSpots);
    }
    var coverage = calculateCoverage(allRouteSpots, currentSidoSpots, null);

    // 4. OSRM 실제 도로 경로 조회 시도
    document.getElementById('loading-text').textContent = '도로 경로 조회 중...';
    await sleep(100);

    for (var v = 0; v < results.length; v++) {
      var waypoints = results[v].spots.filter(function(s) { return s && s.lat; });
      try {
        var osrmResult = await getOSRMRoute(waypoints);
        results[v].osrmGeometry = osrmResult.geometry;
        if (osrmResult.distance > 0) {
          results[v].osrmDistance = osrmResult.distance;
          results[v].osrmDuration = osrmResult.duration;
        }
      } catch (e) {
        console.warn('차량' + (v + 1) + ' OSRM 실패:', e);
        results[v].osrmGeometry = null;
      }
    }

    // 결과 저장
    optimizationResult = { vehicles: results, coverage: coverage, timestamp: new Date() };

    // 5. 지도에 결과 그리기
    drawOptimizationResults(results);

    // 6. 하단 패널에 결과 표시
    renderResultPanel(results, coverage);
    showBottomPanel();

    // 7. 상세보기 버튼 활성화
    document.getElementById('route-detail-btn').disabled = false;

  } catch (err) {
    console.error('최적화 오류:', err);
    alert('경로 최적화 중 오류가 발생했습니다:\n' + err.message);
  } finally {
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    loading.classList.add('hidden');
  }
}

/* ── 지도에 최적화 결과 그리기 ── */
function drawOptimizationResults(results) {
  // 기존 결과 레이어 제거
  clearMapResults();

  results.forEach(function(vr) {
    var color = vr.color;
    var hexColor = VEHICLE_HEX[color] || '#2563eb';

    // 경로 폴리라인
    var latlngs;
    if (vr.osrmGeometry && vr.osrmGeometry.length > 0) {
      latlngs = vr.osrmGeometry;
    } else {
      // 직선 폴백
      latlngs = vr.spots.filter(function(s) { return s && s.lat; }).map(function(s) { return [s.lat, s.lng]; });
    }

    if (latlngs.length > 0) {
      // 외곽선 (두꺼운 반투명)
      var outerLine = L.polyline(latlngs, {
        color: hexColor, weight: 8, opacity: 0.25, lineJoin: 'round', lineCap: 'round'
      }).addTo(map);
      mapLayers.push(outerLine);

      // 본선
      var mainLine = addRoutePolyline(map, latlngs, {
        color: hexColor, weight: 4, opacity: 0.9
      });
      mapLayers.push(mainLine);
    }

    // 출발점 마커 (이미 있으므로 건너뜀)

    // 정거장 번호 마커
    var stopNum = 0;
    for (var i = 0; i < vr.spots.length; i++) {
      var sp = vr.spots[i];
      if (!sp || !sp.lat) continue;

      // 출발점(인덱스 -1)과 마지막 복귀점 건너뛰기
      if (vr.route[i] === -1) continue;

      stopNum++;
      var popup =
        '<div class="text-center">' +
        '<p class="text-xs text-gray-400">' + VEHICLE_NAMES[vr.vehicleId - 1] + ' - 정거장 #' + stopNum + '</p>' +
        '<p class="font-bold text-sm mt-1">' + (sp.name || '거점') + '</p>' +
        (sp.voterReach ? '<p class="text-xs mt-1">유권자 도달: <b>' + fmt(sp.voterReach) + '</b></p>' : '') +
        '</div>';

      var mk = addNumberedMarker(map, sp.lat, sp.lng, stopNum, color, popup);
      mapLayers.push(mk);
    }
  });

  // 모든 포인트가 보이도록 지도 조정
  var allPoints = [];
  if (startPoint) allPoints.push([startPoint.lat, startPoint.lng]);
  results.forEach(function(vr) {
    vr.spots.forEach(function(s) {
      if (s && s.lat) allPoints.push([s.lat, s.lng]);
    });
  });
  if (allPoints.length > 0) fitMapBounds(map, allPoints);
}

function clearMapResults() {
  mapLayers.forEach(function(layer) { map.removeLayer(layer); });
  mapLayers = [];
}

/* ── 하단 결과 패널 ── */
function renderResultPanel(results, coverage) {
  // 탭 바 생성
  var tabsHtml = '<button class="tab-btn active px-3 py-1.5 text-sm font-semibold rounded-lg border border-transparent" onclick="showResultTab(\'summary\', this)">종합</button>';
  results.forEach(function(vr) {
    var hexColor = VEHICLE_HEX[vr.color];
    tabsHtml += '<button class="tab-btn px-3 py-1.5 text-sm font-semibold rounded-lg border border-transparent" onclick="showResultTab(\'v' + vr.vehicleId + '\', this)">' +
      '<span class="inline-block w-2.5 h-2.5 rounded-full mr-1" style="background:' + hexColor + '"></span>' +
      VEHICLE_NAMES[vr.vehicleId - 1] + '</button>';
  });
  document.getElementById('result-tabs').innerHTML = tabsHtml;

  // 종합 탭 콘텐츠
  var totalDist = 0, totalTime = 0, totalCost = 0, totalStops = 0;
  results.forEach(function(vr) {
    var dist = vr.osrmDistance || vr.totalDistance;
    totalDist += dist;
    totalTime += vr.estimatedTime;
    totalCost += vr.estimatedCost;
    totalStops += vr.clusterSpots.length;
  });

  var totalVoterReach = 0;
  results.forEach(function(vr) {
    vr.clusterSpots.forEach(function(s) {
      totalVoterReach += (s.voterReach || 0);
    });
  });

  var summaryHtml =
    '<div class="p-5">' +
    '<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-5">' +
    summaryCard('총 이동거리', totalDist.toFixed(1) + ' km', '&#x1F6E3;&#xFE0F;') +
    summaryCard('총 소요시간', Math.floor(totalTime / 60) + '시간 ' + (totalTime % 60) + '분', '&#x23F1;&#xFE0F;') +
    summaryCard('예상 비용', fmtWon(totalCost), '&#x1F4B0;') +
    summaryCard('유권자 커버리지', coverage.coveragePercent + '%', '&#x1F3AF;') +
    summaryCard('유권자 도달', fmt(totalVoterReach) + '명', '&#x1F4E2;') +
    '</div>' +
    '<div class="grid grid-cols-1 md:grid-cols-' + results.length + ' gap-4">';

  results.forEach(function(vr) {
    var hexColor = VEHICLE_HEX[vr.color];
    var dist = vr.osrmDistance || vr.totalDistance;
    summaryHtml +=
      '<div class="bg-gray-50 rounded-xl p-4 border border-gray-100">' +
      '<div class="flex items-center gap-2 mb-3">' +
      '<span class="inline-block w-3 h-3 rounded-full" style="background:' + hexColor + '"></span>' +
      '<span class="font-bold text-sm">' + VEHICLE_NAMES[vr.vehicleId - 1] + '</span>' +
      '<span class="text-xs text-gray-400">' + vr.clusterSpots.length + '개 거점</span>' +
      '</div>' +
      '<div class="space-y-1.5 text-sm">' +
      '<div class="flex justify-between"><span class="text-gray-500">거리</span><span class="font-semibold">' + dist.toFixed(1) + ' km</span></div>' +
      '<div class="flex justify-between"><span class="text-gray-500">시간</span><span class="font-semibold">' + Math.floor(vr.estimatedTime / 60) + '시간 ' + (vr.estimatedTime % 60) + '분</span></div>' +
      '<div class="flex justify-between"><span class="text-gray-500">비용</span><span class="font-semibold">' + fmtWon(vr.estimatedCost) + '</span></div>' +
      '</div></div>';
  });
  summaryHtml += '</div></div>';

  // 차량별 상세 탭 콘텐츠
  var vehicleTabs = {};
  results.forEach(function(vr) {
    var schedule = vr.schedule || [];
    var dist = vr.osrmDistance || vr.totalDistance;
    var hexColor = VEHICLE_HEX[vr.color];

    var html = '<div class="p-5">';
    html += '<div class="flex items-center gap-3 mb-4">';
    html += '<span class="vehicle-badge text-white" style="background:' + hexColor + '">' + VEHICLE_NAMES[vr.vehicleId - 1] + '</span>';
    html += '<span class="text-sm text-gray-500">' + vr.clusterSpots.length + '개 거점 | ' + dist.toFixed(1) + 'km | ' +
            Math.floor(vr.estimatedTime / 60) + '시간 ' + (vr.estimatedTime % 60) + '분 | ' + fmtWon(vr.estimatedCost) + '</span>';
    html += '</div>';

    // 경로 상세 테이블
    html += '<div class="overflow-x-auto"><table class="data-table text-sm w-full">';
    html += '<thead><tr><th class="w-12">#</th><th>거점명</th><th>구분</th><th>도착 시간</th><th>출발 시간</th><th>체류</th><th>다음 거점까지</th></tr></thead>';
    html += '<tbody>';

    var stopCounter = 0;
    schedule.forEach(function(item, idx) {
      var isDepot = (item.spotIndex === 0);
      var label = '';
      if (isDepot && idx === 0) {
        label = '출발';
      } else if (isDepot && idx === schedule.length - 1) {
        label = '복귀';
      } else {
        stopCounter++;
        label = stopCounter.toString();
      }

      var name = (item.spot && item.spot.name) ? item.spot.name : '출발점';
      var typeStr = isDepot ? '<span class="text-xs text-amber-600 font-medium">출발/복귀</span>' :
                    '<span class="type-badge type-' + ((item.spot && item.spot.type) || '교통') + '">' + ((item.spot && item.spot.type) || '-') + '</span>';

      html += '<tr' + (isDepot ? ' class="bg-amber-50/50"' : '') + '>' +
        '<td class="font-bold text-center">' + label + '</td>' +
        '<td class="font-medium">' + name + '</td>' +
        '<td>' + typeStr + '</td>' +
        '<td>' + item.arrivalTime + '</td>' +
        '<td>' + item.departureTime + '</td>' +
        '<td class="text-gray-500">' + (item.stayMinutes > 0 ? item.stayMinutes + '분' : '-') + '</td>' +
        '<td class="text-gray-500">' +
        (item.distanceToNext > 0 ? item.distanceToNext.toFixed(1) + 'km / ' + item.travelTimeToNext + '분' : '-') +
        '</td></tr>';
    });

    html += '</tbody></table></div></div>';
    vehicleTabs['v' + vr.vehicleId] = html;
  });

  // 탭 콘텐츠 저장
  window._resultTabContents = { summary: summaryHtml };
  Object.keys(vehicleTabs).forEach(function(k) {
    window._resultTabContents[k] = vehicleTabs[k];
  });

  document.getElementById('result-content').innerHTML = summaryHtml;
}

function summaryCard(label, value, icon) {
  return '<div class="bg-gray-50 rounded-xl p-4 border border-gray-100 text-center">' +
    '<div class="text-2xl mb-1">' + icon + '</div>' +
    '<p class="text-xl font-bold text-gray-900">' + value + '</p>' +
    '<p class="text-xs text-gray-500 mt-0.5">' + label + '</p>' +
    '</div>';
}

function showResultTab(tabId, btnEl) {
  // 탭 활성화
  var tabs = document.querySelectorAll('#result-tabs .tab-btn');
  tabs.forEach(function(t) { t.classList.remove('active'); });
  if (btnEl) btnEl.classList.add('active');

  // 콘텐츠 전환
  if (window._resultTabContents && window._resultTabContents[tabId]) {
    document.getElementById('result-content').innerHTML = window._resultTabContents[tabId];
  }
}

/* ── 하단 패널 토글 ── */
function showBottomPanel() {
  var panel = document.getElementById('bottom-panel');
  var bar = document.getElementById('bottom-toggle-bar');
  var icon = document.getElementById('bottom-toggle-icon');
  panel.classList.add('show');
  bar.classList.remove('hidden');
  bar.classList.add('panel-open');
  icon.style.transform = 'rotate(180deg)';
  updateBottomBarPosition();
}

function hideBottomPanel() {
  var panel = document.getElementById('bottom-panel');
  var icon = document.getElementById('bottom-toggle-icon');
  var bar = document.getElementById('bottom-toggle-bar');
  panel.classList.remove('show');
  bar.classList.remove('panel-open');
  icon.style.transform = 'rotate(0deg)';
  bar.style.bottom = '0px';
}

function toggleBottomPanel() {
  var panel = document.getElementById('bottom-panel');
  var isOpen = panel.classList.contains('show');
  if (isOpen) {
    hideBottomPanel();
  } else {
    showBottomPanel();
  }
}

function updateBottomBarPosition() {
  var panel = document.getElementById('bottom-panel');
  var bar = document.getElementById('bottom-toggle-bar');
  if (panel.classList.contains('show')) {
    // 패널 높이만큼 바를 위로 이동
    setTimeout(function() {
      var h = panel.offsetHeight;
      bar.style.bottom = h + 'px';
    }, 50);
  }
}

/* ── 차량 경로 상세보기 팝업 ── */
function showRouteDetail() {
  if (!optimizationResult || !optimizationResult.vehicles || optimizationResult.vehicles.length === 0) {
    alert('먼저 경로 최적화를 실행해주세요.');
    return;
  }

  var results = optimizationResult.vehicles;
  var content = document.getElementById('route-detail-content');
  var html = '';

  results.forEach(function(vr) {
    var hexColor = VEHICLE_HEX[vr.color] || '#2563eb';
    var schedule = vr.schedule || [];

    // 경유지 정보 수집
    var waypoints = [];
    var stopNum = 0;
    schedule.forEach(function(item, idx) {
      var isDepot = (item.spotIndex === 0);
      var label, shortLabel;
      if (isDepot && idx === 0) {
        label = '출발'; shortLabel = '출발';
      } else if (isDepot && idx === schedule.length - 1) {
        label = '복귀'; shortLabel = '복귀';
      } else {
        stopNum++;
        label = '#' + stopNum; shortLabel = '' + stopNum;
      }
      var spot = item.spot;
      if (spot && spot.lat) {
        waypoints.push({
          lat: spot.lat, lng: spot.lng,
          name: spot.name || (isDepot ? '출발점' : '거점'),
          label: label, shortLabel: shortLabel,
          arrivalTime: item.arrivalTime || '',
          departureTime: item.departureTime || '',
          stayMinutes: item.stayMinutes || 0,
          distanceToNext: item.distanceToNext || 0,
          isDepot: isDepot,
          type: spot.type || ''
        });
      }
    });

    if (waypoints.length === 0) return;

    // 좌표 범위 계산 (OSRM 포함)
    var allLats = [], allLngs = [];
    waypoints.forEach(function(w) { allLats.push(w.lat); allLngs.push(w.lng); });
    if (vr.osrmGeometry) {
      vr.osrmGeometry.forEach(function(p) { allLats.push(p[0]); allLngs.push(p[1]); });
    }

    var minLat = Math.min.apply(null, allLats), maxLat = Math.max.apply(null, allLats);
    var minLng = Math.min.apply(null, allLngs), maxLng = Math.max.apply(null, allLngs);

    // 여백 추가
    var latPad = (maxLat - minLat) * 0.2 || 0.005;
    var lngPad = (maxLng - minLng) * 0.2 || 0.005;
    minLat -= latPad; maxLat += latPad;
    minLng -= lngPad; maxLng += lngPad;

    var svgW = 750, svgH = 420;
    var latRange = maxLat - minLat || 0.01;
    var lngRange = maxLng - minLng || 0.01;

    // 종횡비 유지
    var geoAspect = lngRange / latRange;
    var svgAspect = svgW / svgH;
    if (geoAspect > svgAspect) {
      var newLR = lngRange / svgAspect;
      var cLat = (minLat + maxLat) / 2;
      minLat = cLat - newLR / 2; maxLat = cLat + newLR / 2; latRange = newLR;
    } else {
      var newLnR = latRange * svgAspect;
      var cLng = (minLng + maxLng) / 2;
      minLng = cLng - newLnR / 2; maxLng = cLng + newLnR / 2; lngRange = newLnR;
    }

    function toSvg(lat, lng) {
      return { x: ((lng - minLng) / lngRange) * svgW, y: ((maxLat - lat) / latRange) * svgH };
    }

    // 경로 path 생성
    var pathPoints;
    if (vr.osrmGeometry && vr.osrmGeometry.length > 0) {
      pathPoints = vr.osrmGeometry.map(function(p) { return toSvg(p[0], p[1]); });
    } else {
      pathPoints = waypoints.map(function(w) { return toSvg(w.lat, w.lng); });
    }
    var pathD = pathPoints.map(function(p, i) {
      return (i === 0 ? 'M' : 'L') + p.x.toFixed(1) + ',' + p.y.toFixed(1);
    }).join(' ');

    // SVG 생성
    var wpSvg = waypoints.map(function(w) { return toSvg(w.lat, w.lng); });

    var svg = '<svg width="100%" viewBox="0 0 ' + svgW + ' ' + svgH + '" class="bg-gray-50 rounded-xl border border-gray-200" style="min-height:280px">';

    // 경로선 (글로우 + 본선)
    svg += '<path d="' + pathD + '" fill="none" stroke="' + hexColor + '" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" opacity="0.15"/>';
    svg += '<path d="' + pathD + '" fill="none" stroke="' + hexColor + '" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.7" stroke-dasharray="none"/>';

    // 방향 화살표 (경로 중간 지점들에)
    if (pathPoints.length > 10) {
      var step = Math.floor(pathPoints.length / 6);
      for (var ai = step; ai < pathPoints.length - step; ai += step) {
        var ap = pathPoints[ai], apPrev = pathPoints[Math.max(0, ai - 3)];
        var angle = Math.atan2(ap.y - apPrev.y, ap.x - apPrev.x) * 180 / Math.PI;
        svg += '<g transform="translate(' + ap.x.toFixed(1) + ',' + ap.y.toFixed(1) + ') rotate(' + angle.toFixed(1) + ')">';
        svg += '<polygon points="0,-4 8,0 0,4" fill="' + hexColor + '" opacity="0.5"/>';
        svg += '</g>';
      }
    }

    // 연결선 (정거장 사이 점선, OSRM 없을 때는 불필요)
    // 정거장 마커 + 라벨
    wpSvg.forEach(function(sp, i) {
      var w = waypoints[i];
      var r = w.isDepot ? 14 : 11;
      var fill = w.isDepot ? '#f59e0b' : hexColor;

      // 라벨 위치 결정 (위/아래 교대 + 겹침 방지)
      var above = (i % 2 === 0);
      // 첫 번째(출발)는 위에, 마지막(복귀)은 아래에
      if (i === 0) above = true;
      if (i === waypoints.length - 1) above = false;

      // 원형 마커
      svg += '<circle cx="' + sp.x.toFixed(1) + '" cy="' + sp.y.toFixed(1) + '" r="' + r + '" fill="' + fill + '" stroke="white" stroke-width="3" class="route-svg-label"/>';

      // 마커 안 번호
      var fontSize = w.isDepot ? 9 : 10;
      svg += '<text x="' + sp.x.toFixed(1) + '" y="' + (sp.y + 3.5).toFixed(1) + '" text-anchor="middle" font-size="' + fontSize + '" font-weight="700" fill="white" class="route-svg-label">' + w.shortLabel + '</text>';

      // 라벨 배경 + 텍스트
      var nameText = w.name.length > 10 ? w.name.substring(0, 10) + '..' : w.name;
      var ly = above ? sp.y - r - 10 : sp.y + r + 16;
      var timeY = above ? ly - 14 : ly + 14;

      // 배경 rect (가독성)
      svg += '<rect x="' + (sp.x - 48).toFixed(1) + '" y="' + (ly - 11).toFixed(1) + '" width="96" height="14" rx="3" fill="white" opacity="0.85"/>';
      svg += '<text x="' + sp.x.toFixed(1) + '" y="' + ly.toFixed(1) + '" text-anchor="middle" font-size="11" font-weight="600" fill="#1f2937" class="route-svg-label">' + nameText + '</text>';

      // 시간 라벨
      if (w.arrivalTime) {
        svg += '<text x="' + sp.x.toFixed(1) + '" y="' + timeY.toFixed(1) + '" text-anchor="middle" font-size="9" fill="#9ca3af" class="route-svg-label">' + w.arrivalTime + '</text>';
      }
    });

    svg += '</svg>';

    // 차량 섹션 HTML
    var dist = vr.osrmDistance || vr.totalDistance;
    html += '<div class="mb-8 pb-6 border-b border-gray-100 last:border-b-0">';
    html += '<div class="flex items-center gap-2 mb-3">';
    html += '<span class="inline-block w-4 h-4 rounded-full" style="background:' + hexColor + '"></span>';
    html += '<span class="text-base font-bold text-gray-900">' + VEHICLE_NAMES[vr.vehicleId - 1] + '</span>';
    html += '<span class="text-sm text-gray-400">|</span>';
    html += '<span class="text-sm text-gray-500">' + (waypoints.length - 2) + '개 거점</span>';
    html += '<span class="text-sm text-gray-400">|</span>';
    html += '<span class="text-sm text-gray-500">' + dist.toFixed(1) + 'km</span>';
    html += '<span class="text-sm text-gray-400">|</span>';
    html += '<span class="text-sm text-gray-500">' + Math.floor(vr.estimatedTime / 60) + '시간 ' + (vr.estimatedTime % 60) + '분</span>';
    html += '</div>';

    // SVG 경로 다이어그램
    html += svg;

    // 경유지 상세 테이블
    html += '<div class="mt-3 overflow-x-auto">';
    html += '<table class="w-full text-sm border-collapse">';
    html += '<thead><tr class="bg-gray-50 text-xs text-gray-500 uppercase">';
    html += '<th class="px-3 py-2 text-center w-14">순서</th>';
    html += '<th class="px-3 py-2 text-left">거점명</th>';
    html += '<th class="px-3 py-2 text-left">구분</th>';
    html += '<th class="px-3 py-2 text-center">도착</th>';
    html += '<th class="px-3 py-2 text-center">출발</th>';
    html += '<th class="px-3 py-2 text-center">체류</th>';
    html += '<th class="px-3 py-2 text-right">다음까지</th>';
    html += '</tr></thead><tbody>';

    waypoints.forEach(function(w) {
      var bgClass = w.isDepot ? ' bg-amber-50/60' : '';
      var labelColor = w.isDepot ? '#f59e0b' : hexColor;
      var typeHtml = w.isDepot ? '<span class="text-xs text-amber-600 font-medium">출발/복귀</span>' :
        '<span class="type-badge type-' + w.type + '">' + w.type + '</span>';

      html += '<tr class="border-t border-gray-100' + bgClass + '">';
      html += '<td class="px-3 py-1.5 font-bold text-center" style="color:' + labelColor + '">' + w.label + '</td>';
      html += '<td class="px-3 py-1.5 font-medium">' + w.name + '</td>';
      html += '<td class="px-3 py-1.5">' + typeHtml + '</td>';
      html += '<td class="px-3 py-1.5 text-center text-gray-500">' + w.arrivalTime + '</td>';
      html += '<td class="px-3 py-1.5 text-center text-gray-500">' + w.departureTime + '</td>';
      html += '<td class="px-3 py-1.5 text-center text-gray-500">' + (w.stayMinutes > 0 ? w.stayMinutes + '분' : '-') + '</td>';
      html += '<td class="px-3 py-1.5 text-right text-gray-500">' + (w.distanceToNext > 0 ? w.distanceToNext.toFixed(1) + 'km' : '-') + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
    html += '</div>';
  });

  content.innerHTML = html;
  document.getElementById('route-detail-modal').classList.remove('hidden');
}

function closeRouteDetail() {
  document.getElementById('route-detail-modal').classList.add('hidden');
}

/* ── 유틸리티 ── */
function sleep(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}
</script>
</body>
</html>
