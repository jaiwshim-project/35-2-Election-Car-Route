<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>유권자 밀집도 분석 — 일렉션맵AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css">
<script>tailwind.config={theme:{extend:{fontFamily:{sans:['Pretendard Variable','Pretendard','system-ui','sans-serif']}}}}</script>
<link rel="stylesheet" href="css/custom.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<style>
  #voter-map-container { height: calc(100vh - 64px - 44px); }
  .sidebar { width: 340px; transition: transform 0.3s ease; }
  .sidebar.collapsed { transform: translateX(-100%); }
  .sidebar-toggle {
    position: absolute; top: 12px; left: 12px; z-index: 1000;
    background: white; border: none; border-radius: 8px;
    padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer; font-size: 14px; font-weight: 600;
  }
  .filter-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 6px 14px; border-radius: 9999px; font-size: 13px;
    font-weight: 500; cursor: pointer; transition: all 0.2s;
    border: 1.5px solid #e2e8f0; background: white; color: #475569;
  }
  .filter-chip.active { border-color: #2563eb; background: #eff6ff; color: #2563eb; }
  .filter-chip:hover { border-color: #93c5fd; }
  .time-btn {
    padding: 6px 12px; border-radius: 8px; font-size: 12px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    border: 1.5px solid #e2e8f0; background: white; color: #475569;
  }
  .time-btn.active { border-color: #2563eb; background: #2563eb; color: white; }
  .time-btn:hover { border-color: #93c5fd; }
  .toggle-group {
    display: flex; border-radius: 8px; overflow: hidden; border: 1.5px solid #e2e8f0;
  }
  .toggle-btn {
    flex: 1; padding: 8px 0; text-align: center; font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    background: white; color: #64748b;
  }
  .toggle-btn.active { background: #2563eb; color: white; }
  .cluster-item {
    padding: 10px 12px; border-radius: 10px; border: 1px solid #e2e8f0;
    background: #f8fafc; cursor: pointer; transition: all 0.2s;
  }
  .cluster-item:hover { border-color: #93c5fd; background: #eff6ff; }
  .legend-collapsed #legend-body { display: none; }
  .legend-collapsed { min-width: auto !important; }
  @media (max-width: 768px) {
    .sidebar { position: absolute; z-index: 999; height: 100%; width: 300px; }
  }
</style>
</head>
<body class="antialiased bg-white text-gray-900">
<div id="test-banner"></div>
<div id="app-header"></div>

<div class="relative flex" style="height: calc(100vh - 64px - 44px);">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar bg-white border-r border-gray-200 flex flex-col overflow-y-auto shrink-0">
    <div class="p-5 space-y-5">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-900">유권자 밀집도 분석</h2>
        <button onclick="toggleSidebar()" class="md:hidden p-1 text-gray-400 hover:text-gray-700 rounded">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- District Selector -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">선거구 선택</label>
        <select id="district-select" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" onchange="onDistrictChange()">
          <option value="">전체 보기</option>
        </select>
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-100"></div>

      <!-- Age Group Filter -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">연령대 필터</label>
        <div class="flex flex-wrap gap-2">
          <label class="filter-chip active"><input type="checkbox" class="sr-only" value="20" checked onchange="onFilterChange()"><span>20대</span></label>
          <label class="filter-chip active"><input type="checkbox" class="sr-only" value="30" checked onchange="onFilterChange()"><span>30대</span></label>
          <label class="filter-chip active"><input type="checkbox" class="sr-only" value="40" checked onchange="onFilterChange()"><span>40대</span></label>
          <label class="filter-chip active"><input type="checkbox" class="sr-only" value="50" checked onchange="onFilterChange()"><span>50대</span></label>
          <label class="filter-chip active"><input type="checkbox" class="sr-only" value="60" checked onchange="onFilterChange()"><span>60대+</span></label>
        </div>
      </div>

      <!-- Time Period -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">시간대 선택</label>
        <div class="grid grid-cols-2 gap-2">
          <button class="time-btn active" data-time="commute-morning" onclick="selectTimePeriod(this)">출근 (07-09)</button>
          <button class="time-btn" data-time="lunch" onclick="selectTimePeriod(this)">점심 (11-13)</button>
          <button class="time-btn" data-time="commute-evening" onclick="selectTimePeriod(this)">퇴근 (17-19)</button>
          <button class="time-btn" data-time="night" onclick="selectTimePeriod(this)">야간 (19-22)</button>
        </div>
      </div>

      <!-- Population Toggle -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">인구 유형</label>
        <div class="toggle-group">
          <div class="toggle-btn active" data-type="floating" onclick="selectPopType(this)">유동인구</div>
          <div class="toggle-btn" data-type="resident" onclick="selectPopType(this)">거주인구</div>
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-100"></div>

      <!-- Cluster Analysis Button -->
      <button id="cluster-btn" onclick="runClusterAnalysis()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition shadow-sm flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        클러스터 분석
      </button>

      <!-- Route Overlay Button -->
      <button id="route-btn" onclick="toggleRouteOverlay()" class="w-full bg-emerald-600 text-white font-semibold py-3 rounded-xl hover:bg-emerald-700 transition shadow-sm flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
        이동경로 보기
      </button>

      <!-- Route Overlay Results -->
      <div id="route-results" class="hidden space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-bold text-gray-800">최적 이동경로</h3>
          <button onclick="hideRouteOverlay()" class="text-xs text-red-500 hover:text-red-700 font-semibold">경로 숨기기</button>
        </div>
        <div id="route-info" class="space-y-2"></div>
      </div>

      <!-- Cluster Results -->
      <div id="cluster-results" class="hidden space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-bold text-gray-800">클러스터 분석 결과</h3>
          <span id="cluster-count" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-semibold"></span>
        </div>
        <div id="cluster-list" class="space-y-2"></div>
        <div id="cluster-summary" class="bg-blue-50 rounded-lg p-3 text-sm text-blue-800"></div>
      </div>

      <!-- Spot Info -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">거점 정보</label>
        <div id="spot-count" class="text-sm text-gray-500">선거구를 선택하면 거점 정보가 표시됩니다.</div>
      </div>
    </div>
  </aside>

  <!-- Map Area -->
  <div class="flex-1 relative">
    <button id="sidebar-toggle-btn" onclick="toggleSidebar()" class="sidebar-toggle hidden">
      <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      필터
    </button>
    <div id="map" class="w-full h-full"></div>
    <!-- Legend -->
    <div id="map-legend" class="absolute bottom-6 right-6 bg-white rounded-xl shadow-lg border border-gray-200 z-[500] transition-all" style="min-width:220px; max-height: calc(100% - 48px); overflow-y:auto;">
      <!-- Legend Header -->
      <div class="flex items-center justify-between px-4 pt-3 pb-2 border-b border-gray-100 sticky top-0 bg-white rounded-t-xl">
        <h4 class="text-xs font-bold text-gray-800 uppercase tracking-wider">범례</h4>
        <button onclick="document.getElementById('map-legend').classList.toggle('legend-collapsed')" class="text-gray-400 hover:text-gray-700 transition p-0.5 rounded">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
      </div>
      <div id="legend-body" class="p-4 space-y-4">

        <!-- 1. 히트맵 밀집도 -->
        <div>
          <p class="text-[11px] font-semibold text-gray-700 mb-1.5">유권자 밀집도 (히트맵)</p>
          <div class="flex items-center gap-1.5">
            <span class="text-[10px] text-gray-400 w-6 text-right shrink-0">낮음</span>
            <div class="flex-1 h-3.5 rounded-md" style="background:linear-gradient(to right,#ffffb2,#fed976,#feb24c,#fd8d3c,#f03b20,#bd0026)"></div>
            <span class="text-[10px] text-gray-400 w-6 shrink-0">높음</span>
          </div>
          <div class="flex justify-between mt-1 px-7">
            <span class="text-[9px] text-gray-400">~1,000명</span>
            <span class="text-[9px] text-gray-400">~5,000명</span>
            <span class="text-[9px] text-gray-400">10,000명+</span>
          </div>
        </div>

        <div class="border-t border-gray-100"></div>

        <!-- 2. 거점 유형별 마커 -->
        <div>
          <p class="text-[11px] font-semibold text-gray-700 mb-2">유세 거점 유형</p>
          <div class="grid grid-cols-2 gap-x-3 gap-y-1.5">
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#2563eb; border:1.5px solid white; box-shadow:0 0 0 1px #2563eb;"></span>
              <span class="text-[11px] text-gray-600">교통 (역·정류장)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#ea580c; border:1.5px solid white; box-shadow:0 0 0 1px #ea580c;"></span>
              <span class="text-[11px] text-gray-600">시장 (재래시장)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#059669; border:1.5px solid white; box-shadow:0 0 0 1px #059669;"></span>
              <span class="text-[11px] text-gray-600">주거 (아파트단지)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#7c3aed; border:1.5px solid white; box-shadow:0 0 0 1px #7c3aed;"></span>
              <span class="text-[11px] text-gray-600">대학교</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#06b6d4; border:1.5px solid white; box-shadow:0 0 0 1px #06b6d4;"></span>
              <span class="text-[11px] text-gray-600">공원 (호수·공원)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#d97706; border:1.5px solid white; box-shadow:0 0 0 1px #d97706;"></span>
              <span class="text-[11px] text-gray-600">상업 (상가·거리)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#e11d48; border:1.5px solid white; box-shadow:0 0 0 1px #e11d48;"></span>
              <span class="text-[11px] text-gray-600">관광 (문화재)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:#6366f1; border:1.5px solid white; box-shadow:0 0 0 1px #6366f1;"></span>
              <span class="text-[11px] text-gray-600">관공서 (구청 등)</span>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-100"></div>

        <!-- 3. 클러스터 분석 표시 -->
        <div>
          <p class="text-[11px] font-semibold text-gray-700 mb-2">클러스터 분석</p>
          <div class="space-y-1.5">
            <div class="flex items-center gap-2">
              <span class="w-5 h-5 rounded-full bg-blue-600 text-white text-[9px] font-bold flex items-center justify-center shrink-0 border-2 border-white shadow">1</span>
              <span class="text-[11px] text-gray-600">클러스터 중심 (추천 유세 거점)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-5 h-5 rounded-full shrink-0 border-2 border-dashed border-blue-400 bg-blue-50"></span>
              <span class="text-[11px] text-gray-600">클러스터 영역 (점선 원)</span>
            </div>
          </div>
          <div class="mt-2 flex flex-wrap gap-1">
            <span class="inline-block w-3 h-3 rounded-full bg-blue-600"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-red-600"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-emerald-600"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-orange-500"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-purple-600"></span>
            <span class="text-[10px] text-gray-400 ml-1">클러스터별 색상 구분</span>
          </div>
        </div>

        <div class="border-t border-gray-100"></div>

        <!-- 4. 필터 현재 상태 -->
        <div>
          <p class="text-[11px] font-semibold text-gray-700 mb-2">현재 필터 설정</p>
          <div id="legend-filter-status" class="space-y-1 text-[11px] text-gray-500">
          </div>
        </div>

        <div class="border-t border-gray-100"></div>

        <!-- 5. 데이터 출처 -->
        <div>
          <p class="text-[11px] font-semibold text-gray-700 mb-1.5">데이터 출처</p>
          <div class="text-[10px] text-gray-400 space-y-0.5">
            <p>유권자 수: 중앙선거관리위원회</p>
            <p>유동인구: 행정안전부 (MOIS)</p>
            <p>인구통계: 국가통계포털 (KOSIS)</p>
            <p>지도: OpenStreetMap Contributors</p>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div id="app-footer"></div>

<script src="js/mock-data.js"></script>
<script src="js/shared.js"></script>
<script src="js/map-engine.js"></script>
<script src="js/route-algorithm.js"></script>
<script>
initPage('voter-map');

/* ── 상태 변수 ── */
var map, heatLayer, markerGroup, clusterMarkerGroup, routeLayerGroup;
var currentDistrict = '';
var activeTimePeriod = 'commute-morning';
var populationType = 'floating';
var activeAgeGroups = [20, 30, 40, 50, 60];
var clusterResults = [];
var routeVisible = false;

/* ── 초기화 ── */
(function init() {
  // 지도 초기화
  map = initMap('map', [37.2636, 127.0286], 12);
  markerGroup = createLayerGroup(map);
  clusterMarkerGroup = createLayerGroup(map);
  routeLayerGroup = createLayerGroup(map);

  // 선거구 드롭다운 채우기
  var sel = document.getElementById('district-select');
  DISTRICTS.forEach(function(d) {
    var opt = document.createElement('option');
    opt.value = d.dong;
    opt.textContent = d.sigungu + ' ' + d.dong;
    sel.appendChild(opt);
  });

  // 필터 칩 이벤트
  document.querySelectorAll('.filter-chip input').forEach(function(cb) {
    cb.parentElement.addEventListener('click', function() {
      cb.checked = !cb.checked;
      this.classList.toggle('active', cb.checked);
      onFilterChange();
    });
  });

  // 전체 데이터로 초기 히트맵
  updateMap();
})();

/* ── 선거구 변경 ── */
function onDistrictChange() {
  currentDistrict = document.getElementById('district-select').value;
  clusterResults = [];
  document.getElementById('cluster-results').classList.add('hidden');
  clearLayers(map, clusterMarkerGroup);
  updateMap();
}

/* ── 필터 변경 ── */
function onFilterChange() {
  activeAgeGroups = [];
  document.querySelectorAll('.filter-chip input').forEach(function(cb) {
    if (cb.checked) activeAgeGroups.push(parseInt(cb.value));
  });
  updateMap();
}

/* ── 시간대 선택 ── */
function selectTimePeriod(btn) {
  document.querySelectorAll('.time-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  activeTimePeriod = btn.dataset.time;
  updateMap();
}

/* ── 인구 유형 선택 ── */
function selectPopType(btn) {
  document.querySelectorAll('.toggle-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  populationType = btn.dataset.type;
  updateMap();
}

/* ── 사이드바 토글 ── */
function toggleSidebar() {
  var sidebar = document.getElementById('sidebar');
  var toggleBtn = document.getElementById('sidebar-toggle-btn');
  sidebar.classList.toggle('collapsed');
  if (sidebar.classList.contains('collapsed')) {
    toggleBtn.classList.remove('hidden');
  } else {
    toggleBtn.classList.add('hidden');
  }
  setTimeout(function() { map.invalidateSize(); }, 350);
}

/* ── 시간대별 가중치 ── */
function getTimeWeight() {
  var weights = {
    'commute-morning': { hours: [7, 8], multiplier: 1.0 },
    'lunch':           { hours: [11, 12], multiplier: 0.75 },
    'commute-evening': { hours: [17, 18], multiplier: 0.95 },
    'night':           { hours: [19, 20, 21], multiplier: 0.6 }
  };
  return weights[activeTimePeriod] || weights['commute-morning'];
}

/* ── 연령 가중치 계산 ── */
function getAgeWeight(district) {
  if (!district) return 1;
  var total = 0;
  if (activeAgeGroups.indexOf(20) >= 0) total += district.age_20s_pct;
  if (activeAgeGroups.indexOf(30) >= 0) total += district.age_30s_pct;
  if (activeAgeGroups.indexOf(40) >= 0) total += district.age_40s_pct;
  if (activeAgeGroups.indexOf(50) >= 0) total += district.age_50s_pct;
  if (activeAgeGroups.indexOf(60) >= 0) total += district.age_60plus_pct;
  return total / 100;
}

/* ── 히트맵 포인트 생성 ── */
function generateHeatPoints(spots, district) {
  var points = [];
  var timeWeight = getTimeWeight();
  var ageWeight = district ? getAgeWeight(district) : 0.8;
  var popMultiplier = populationType === 'floating' ? 1.0 : 0.7;

  spots.forEach(function(spot) {
    var baseIntensity = (spot.voterReach / 12000) * ageWeight * popMultiplier;

    // 시간대에 맞는 스팟 유형 가중치
    var spotType = mapSpotTypeToPattern(spot.type);
    var patternData = TIME_PATTERNS[spotType];
    if (patternData) {
      var hourAvg = 0;
      timeWeight.hours.forEach(function(h) { hourAvg += patternData[h]; });
      hourAvg /= timeWeight.hours.length;
      baseIntensity *= hourAvg;
    } else {
      baseIntensity *= timeWeight.multiplier;
    }

    // 거점 주변에 랜덤 포인트 생성
    var numPoints = Math.max(5, Math.round(spot.voterReach / 500));
    for (var i = 0; i < numPoints; i++) {
      var angle = Math.random() * Math.PI * 2;
      var dist = Math.random() * 0.008;
      var lat = spot.lat + Math.cos(angle) * dist;
      var lng = spot.lng + Math.sin(angle) * dist;
      var intensity = baseIntensity * (0.5 + Math.random() * 0.5);
      points.push([lat, lng, Math.min(1, intensity)]);
    }
  });

  return points;
}

/* ── 스팟 유형을 TIME_PATTERNS 키로 매핑 ── */
function mapSpotTypeToPattern(type) {
  var mapping = {
    '교통': '역세권',
    '시장': '시장',
    '주거': '아파트단지',
    '대학교': '대학교',
    '공원': '공원',
    '상업': '역세권',
    '관광': '공원',
    '관공서': '대학교'
  };
  return mapping[type] || '역세권';
}

/* ── 범례 필터 상태 업데이트 ── */
function updateLegendStatus() {
  var timeLabels = {
    'commute-morning': '출근 (07~09시)',
    'lunch': '점심 (11~13시)',
    'commute-evening': '퇴근 (17~19시)',
    'night': '야간 (19~22시)'
  };
  var ageText = activeAgeGroups.length === 5 ? '전 연령대' : activeAgeGroups.map(function(a) { return a + '대' + (a === 60 ? '+' : ''); }).join(', ');
  var distText = currentDistrict || '전체 선거구';
  var popText = populationType === 'floating' ? '유동인구' : '거주인구';
  var el = document.getElementById('legend-filter-status');
  if (el) {
    el.innerHTML =
      '<div class="flex items-center gap-1.5"><svg class="w-3 h-3 text-blue-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>선거구: <b class="text-gray-700">' + distText + '</b></span></div>' +
      '<div class="flex items-center gap-1.5"><svg class="w-3 h-3 text-amber-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>시간대: <b class="text-gray-700">' + timeLabels[activeTimePeriod] + '</b></span></div>' +
      '<div class="flex items-center gap-1.5"><svg class="w-3 h-3 text-emerald-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>연령: <b class="text-gray-700">' + ageText + '</b></span></div>' +
      '<div class="flex items-center gap-1.5"><svg class="w-3 h-3 text-purple-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span>인구 유형: <b class="text-gray-700">' + popText + '</b></span></div>';
  }
}

/* ── 지도 업데이트 ── */
function updateMap() {
  // 기존 레이어 제거
  if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
  clearLayers(map, markerGroup);

  // 거점 필터링
  var spots;
  var district = null;
  if (currentDistrict) {
    spots = getSpotsForDistrict(currentDistrict);
    district = DISTRICTS.find(function(d) { return d.dong === currentDistrict; });
  } else {
    spots = CAMPAIGN_SPOTS;
  }

  if (spots.length === 0) {
    document.getElementById('spot-count').textContent = '해당 선거구에 거점이 없습니다.';
    return;
  }

  // 히트맵 생성
  var heatPoints = generateHeatPoints(spots, district);
  heatLayer = addHeatLayer(map, heatPoints, { radius: 20, blur: 18 });

  // 거점 마커
  spots.forEach(function(spot) {
    var typeColors = {
      '교통': '#2563eb', '시장': '#ea580c', '주거': '#059669',
      '대학교': '#7c3aed', '공원': '#06b6d4', '상업': '#d97706',
      '관광': '#e11d48', '관공서': '#6366f1'
    };
    var color = typeColors[spot.type] || '#6b7280';

    var icon = L.divIcon({
      className: 'custom-div-icon',
      html: '<div style="background:' + color + ';color:white;border-radius:50%;width:10px;height:10px;border:2px solid white;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></div>',
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });

    var marker = L.marker([spot.lat, spot.lng], { icon: icon });
    marker.bindPopup(
      '<div class="text-sm">' +
      '<p class="font-bold text-gray-900 text-base">' + spot.name + '</p>' +
      '<div class="mt-2 space-y-1">' +
      '<p><span class="text-gray-500">유형:</span> <span class="font-medium" style="color:' + color + '">' + spot.type + '</span></p>' +
      '<p><span class="text-gray-500">유권자 접촉:</span> <span class="font-semibold text-blue-600">' + fmt(spot.voterReach) + '명</span></p>' +
      '<p><span class="text-gray-500">피크 시간:</span> <span class="font-medium">' + spot.peakHour + '</span></p>' +
      '<p><span class="text-gray-500">일일 비용:</span> <span class="font-medium">' + fmt(spot.dailyCost) + '원</span></p>' +
      '</div></div>', { maxWidth: 240 }
    );
    markerGroup.addLayer(marker);
  });

  // 지도 맞춤
  if (currentDistrict && district) {
    map.setView([district.lat, district.lng], 13);
  }

  // 거점 정보
  var totalReach = spots.reduce(function(sum, s) { return sum + s.voterReach; }, 0);
  document.getElementById('spot-count').innerHTML =
    '<div class="space-y-1">' +
    '<p class="font-semibold text-gray-800">거점 ' + spots.length + '곳</p>' +
    '<p>총 유권자 접촉: <span class="font-bold text-blue-600">' + fmt(totalReach) + '명</span></p>' +
    '</div>';

  // 범례 필터 상태 업데이트
  updateLegendStatus();
}

/* ── K-means 클러스터링 ── */
function kMeansClustering(points, k, maxIter) {
  maxIter = maxIter || 50;
  if (points.length === 0 || k <= 0) return [];
  k = Math.min(k, points.length);

  // 초기 중심: 랜덤 선택
  var shuffled = points.slice().sort(function() { return Math.random() - 0.5; });
  var centroids = shuffled.slice(0, k).map(function(p) {
    return { lat: p.lat, lng: p.lng };
  });

  var assignments = new Array(points.length);

  for (var iter = 0; iter < maxIter; iter++) {
    // 포인트 할당
    var changed = false;
    for (var i = 0; i < points.length; i++) {
      var minDist = Infinity;
      var minIdx = 0;
      for (var j = 0; j < centroids.length; j++) {
        var dlat = points[i].lat - centroids[j].lat;
        var dlng = points[i].lng - centroids[j].lng;
        var d = dlat * dlat + dlng * dlng;
        if (d < minDist) { minDist = d; minIdx = j; }
      }
      if (assignments[i] !== minIdx) { assignments[i] = minIdx; changed = true; }
    }

    if (!changed) break;

    // 중심 업데이트
    for (var c = 0; c < centroids.length; c++) {
      var sumLat = 0, sumLng = 0, sumWeight = 0, count = 0;
      for (var p = 0; p < points.length; p++) {
        if (assignments[p] === c) {
          var w = points[p].weight || 1;
          sumLat += points[p].lat * w;
          sumLng += points[p].lng * w;
          sumWeight += w;
          count++;
        }
      }
      if (count > 0) {
        centroids[c].lat = sumLat / sumWeight;
        centroids[c].lng = sumLng / sumWeight;
      }
    }
  }

  // 결과 정리
  var results = centroids.map(function(c, idx) {
    return { center: { lat: c.lat, lng: c.lng }, points: [], totalWeight: 0 };
  });
  for (var i = 0; i < points.length; i++) {
    results[assignments[i]].points.push(points[i]);
    results[assignments[i]].totalWeight += (points[i].weight || 1);
  }

  // 가중치 내림차순 정렬
  results.sort(function(a, b) { return b.totalWeight - a.totalWeight; });

  return results;
}

/* ── 클러스터 분석 실행 ── */
function runClusterAnalysis() {
  var btn = document.getElementById('cluster-btn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg> 분석 중...';

  setTimeout(function() {
    // 현재 거점 데이터
    var spots;
    if (currentDistrict) {
      spots = getSpotsForDistrict(currentDistrict);
    } else {
      spots = CAMPAIGN_SPOTS;
    }

    var clusterPoints = spots.map(function(s) {
      return { lat: s.lat, lng: s.lng, weight: s.voterReach, name: s.name };
    });

    // k 값 결정: 거점 수에 따라
    var k = Math.min(Math.max(3, Math.round(spots.length / 4)), 8);
    clusterResults = kMeansClustering(clusterPoints, k);

    // 클러스터 마커 표시
    clearLayers(map, clusterMarkerGroup);
    var colors = ['blue', 'red', 'green', 'orange', 'purple', 'blue', 'red', 'green'];
    var colorHex = ['#2563eb', '#dc2626', '#059669', '#ea580c', '#7c3aed', '#2563eb', '#dc2626', '#059669'];

    clusterResults.forEach(function(cluster, idx) {
      // 클러스터 영역 원
      var maxDist = 0;
      cluster.points.forEach(function(p) {
        var dlat = p.lat - cluster.center.lat;
        var dlng = p.lng - cluster.center.lng;
        var d = Math.sqrt(dlat * dlat + dlng * dlng);
        if (d > maxDist) maxDist = d;
      });
      var radiusM = Math.max(300, maxDist * 111000);

      var circle = L.circle([cluster.center.lat, cluster.center.lng], {
        radius: radiusM,
        color: colorHex[idx % colorHex.length],
        fillColor: colorHex[idx % colorHex.length],
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '5,5'
      });
      clusterMarkerGroup.addLayer(circle);

      // 중심 마커
      var spotNames = cluster.points.map(function(p) { return p.name; }).join(', ');
      var popupHtml = '<div class="text-sm">' +
        '<p class="font-bold text-base">클러스터 ' + (idx + 1) + '</p>' +
        '<p class="mt-1"><span class="text-gray-500">거점 수:</span> <span class="font-semibold">' + cluster.points.length + '곳</span></p>' +
        '<p><span class="text-gray-500">총 유권자:</span> <span class="font-bold text-blue-600">' + fmt(cluster.totalWeight) + '명</span></p>' +
        '<p class="mt-1 text-gray-500 text-xs">포함 거점: ' + spotNames + '</p>' +
        '</div>';

      var marker = addNumberedMarker(map, cluster.center.lat, cluster.center.lng, idx + 1, colors[idx % colors.length], popupHtml);
      clusterMarkerGroup.addLayer(marker);
    });

    // 결과 패널 업데이트
    document.getElementById('cluster-results').classList.remove('hidden');
    document.getElementById('cluster-count').textContent = clusterResults.length + '개 클러스터';

    var listHtml = '';
    clusterResults.forEach(function(cluster, idx) {
      listHtml += '<div class="cluster-item" onclick="map.setView([' + cluster.center.lat + ',' + cluster.center.lng + '],14)">' +
        '<div class="flex items-center gap-3">' +
        '<div class="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold shrink-0" style="background:' + colorHex[idx % colorHex.length] + '">' + (idx + 1) + '</div>' +
        '<div class="min-w-0">' +
        '<p class="text-sm font-semibold text-gray-800 truncate">클러스터 ' + (idx + 1) + ' (' + cluster.points.length + '곳)</p>' +
        '<p class="text-xs text-gray-500">유권자 접촉: ' + fmt(cluster.totalWeight) + '명</p>' +
        '</div></div></div>';
    });
    document.getElementById('cluster-list').innerHTML = listHtml;

    var totalWeight = clusterResults.reduce(function(s, c) { return s + c.totalWeight; }, 0);
    var topCluster = clusterResults[0];
    document.getElementById('cluster-summary').innerHTML =
      '<p class="font-semibold mb-1">분석 요약</p>' +
      '<p>총 유권자 접촉: <span class="font-bold">' + fmt(totalWeight) + '명</span></p>' +
      '<p>최대 밀집 클러스터: <span class="font-bold">클러스터 1</span> (' + fmt(topCluster.totalWeight) + '명)</p>' +
      '<p class="mt-1 text-xs text-blue-600">클러스터 중심에 유세 차량을 배치하면 효율이 극대화됩니다.</p>';

    btn.disabled = false;
    btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> 클러스터 분석';
  }, 600);
}

/* ── 이동경로 오버레이 ── */
function toggleRouteOverlay() {
  if (routeVisible) {
    hideRouteOverlay();
    return;
  }

  var btn = document.getElementById('route-btn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg> 경로 계산 중...';

  setTimeout(function() {
    var spots;
    if (currentDistrict) {
      spots = getSpotsForDistrict(currentDistrict);
    } else {
      // 전체 보기: voterReach 높은 순 정렬 후 상위 20개
      spots = CAMPAIGN_SPOTS.slice().sort(function(a, b) { return b.voterReach - a.voterReach; }).slice(0, 20);
    }

    if (spots.length < 2) {
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg> 이동경로 보기';
      alert('경로를 계산하려면 최소 2개 이상의 거점이 필요합니다.');
      return;
    }

    // voterReach 높은 순 정렬
    spots = spots.slice().sort(function(a, b) { return b.voterReach - a.voterReach; });

    // 출발점: 첫 번째(가장 유권자 많은) 거점
    var startPoint = { lat: spots[0].lat, lng: spots[0].lng };
    var numVehicles = Math.min(3, Math.max(1, Math.ceil(spots.length / 5)));

    // 경로 최적화 실행
    var plan = vehicleRoutePlan(spots, numVehicles, startPoint);

    // 레이어 초기화
    clearLayers(map, routeLayerGroup);

    var vehicleColors = ['#2563eb', '#dc2626', '#059669', '#ea580c', '#7c3aed'];
    var vehicleNames = ['차량 A', '차량 B', '차량 C', '차량 D', '차량 E'];
    var routeInfoHtml = '';

    plan.forEach(function(vehicle, vIdx) {
      var color = vehicleColors[vIdx % vehicleColors.length];

      // 경로 폴리라인 생성: route에서 -1(출발점)을 제외한 거점 인덱스만 추출
      var spotIndices = vehicle.route.filter(function(idx) { return idx >= 0; });
      var routeCoords = [];
      // 출발점 → 각 거점 → 복귀
      routeCoords.push([startPoint.lat, startPoint.lng]);
      spotIndices.forEach(function(spotIdx) {
        if (spots[spotIdx]) routeCoords.push([spots[spotIdx].lat, spots[spotIdx].lng]);
      });
      routeCoords.push([startPoint.lat, startPoint.lng]);

      // 외곽선 (두꺼운 반투명)
      var outerLine = L.polyline(routeCoords, {
        color: color, weight: 8, opacity: 0.25, lineCap: 'round', lineJoin: 'round'
      });
      routeLayerGroup.addLayer(outerLine);

      // 내부선 (실선)
      var innerLine = L.polyline(routeCoords, {
        color: color, weight: 3.5, opacity: 0.9, lineCap: 'round', lineJoin: 'round'
      });
      routeLayerGroup.addLayer(innerLine);

      // 경유지 번호 마커
      spotIndices.forEach(function(spotIdx, order) {
        var s = spots[spotIdx];
        if (!s) return;
        var icon = L.divIcon({
          className: '',
          html: '<div style="background:' + color + ';color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid white;box-shadow:0 1px 6px rgba(0,0,0,0.35);">' + (order + 1) + '</div>',
          iconSize: [22, 22], iconAnchor: [11, 11]
        });
        var m = L.marker([s.lat, s.lng], { icon: icon, zIndexOffset: 1000 });
        m.bindPopup('<div class="text-sm"><b>' + vehicleNames[vIdx] + ' - ' + (order + 1) + '번째</b><br>' + s.name + '<br>유권자: ' + fmt(s.voterReach) + '명</div>');
        routeLayerGroup.addLayer(m);
      });

      // 출발점 마커
      if (vIdx === 0) {
        var startIcon = L.divIcon({
          className: '',
          html: '<div style="background:#f59e0b;color:white;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;border:2.5px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">S</div>',
          iconSize: [26, 26], iconAnchor: [13, 13]
        });
        var sm = L.marker([startPoint.lat, startPoint.lng], { icon: startIcon, zIndexOffset: 2000 });
        sm.bindPopup('<div class="text-sm"><b>출발점</b><br>' + spots[0].name + '</div>');
        routeLayerGroup.addLayer(sm);
      }

      // 정보 카드: -1(출발점) 제외한 거점만
      var vehicleSpots = spotIndices.map(function(idx) { return spots[idx]; }).filter(Boolean);
      var totalReach = vehicleSpots.reduce(function(s, sp) { return s + (sp.voterReach || 0); }, 0);
      routeInfoHtml +=
        '<div class="bg-white rounded-lg border border-gray-200 p-3">' +
        '<div class="flex items-center gap-2 mb-2">' +
        '<span class="w-5 h-5 rounded-full text-white text-[10px] font-bold flex items-center justify-center" style="background:' + color + '">' + String.fromCharCode(65 + vIdx) + '</span>' +
        '<span class="text-sm font-bold text-gray-800">' + vehicleNames[vIdx] + '</span>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-2 text-[11px]">' +
        '<div><span class="text-gray-500">거점:</span> <b>' + spotIndices.length + '곳</b></div>' +
        '<div><span class="text-gray-500">거리:</span> <b>' + vehicle.totalDistance.toFixed(1) + 'km</b></div>' +
        '<div><span class="text-gray-500">시간:</span> <b>' + vehicle.estimatedTime + '분</b></div>' +
        '<div><span class="text-gray-500">유권자:</span> <b class="text-blue-600">' + fmt(totalReach) + '명</b></div>' +
        '</div>' +
        '<div class="mt-2 text-[10px] text-gray-400">순서: ' + vehicleSpots.map(function(sp) { return sp.name; }).join(' → ') + '</div>' +
        '</div>';
    });

    // 결과 패널 표시
    document.getElementById('route-info').innerHTML = routeInfoHtml;
    document.getElementById('route-results').classList.remove('hidden');

    routeVisible = true;
    btn.disabled = false;
    btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
    btn.classList.add('bg-red-500', 'hover:bg-red-600');
    btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/></svg> 이동경로 숨기기';
  }, 500);
}

function hideRouteOverlay() {
  clearLayers(map, routeLayerGroup);
  routeVisible = false;
  document.getElementById('route-results').classList.add('hidden');

  var btn = document.getElementById('route-btn');
  btn.classList.remove('bg-red-500', 'hover:bg-red-600');
  btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
  btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg> 이동경로 보기';
}
</script>
</body>
</html>
